<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel Asesor - NextGenMotors</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link href="https://fonts.googleapis.com" rel="preconnect">
  <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect">
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <style>

    /* Estilos para estados de citas */
.estado-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 1rem;
    font-size: 0.875rem;
    font-weight: 600;
    display: inline-block;
}

.estado-pendiente { background: #fef3c7; color: #92400e; }
.estado-aprobada { background: #dcfce7; color: #166534; }
.estado-rechazada { background: #fecaca; color: #dc2626; }
.estado-contactado { background: #dbeafe; color: #1e40af; }

/* Botones de gestión de citas */
.btn-gestion-cita {
    padding: 0.4rem 0.8rem;
    border-radius: 0.375rem;
    font-size: 0.75rem;
    font-weight: 500;
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
    margin: 0.1rem;
}

.btn-aprobar { background: #10b981; color: white; }
.btn-rechazar { background: #ef4444; color: white; }
.btn-asignar-fecha { background: #3b82f6; color: white; }
.btn-pendiente { background: #f59e0b; color: white; }
.btn-notas { background: #8b5cf6; color: white; }

.btn-gestion-cita:hover {
    transform: translateY(-1px);
    opacity: 0.9;
}

.btn-secondary {
    background: #6b7280;
    color: white;
    padding: 0.75rem 1.5rem;
    border-radius: 0.5rem;
    border: none;
    cursor: pointer;
}
    body {
        font-family: 'Manrope', sans-serif;
        background-color: #f6f7f8;
        color: #1e293b;
        margin: 0;
        padding: 0;
    }
    .dark body { background-color: #101922; color: #e2e8f0; }

    .asesor-primary { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
    .asesor-secondary { background-color: #eff6ff; }
    .dark .asesor-secondary { background-color: #1e3a8a; }
    .asesor-accent { color: #3b82f6; }

    .navbar {
        position: sticky;
        top: 0;
        z-index: 50;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 2rem;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }
    .dark .navbar { background: rgba(16, 25, 34, 0.9); }

    .nav-logo { display: flex; align-items: center; font-weight: 800; font-size: 1.5rem; }
    .logo-nexgen { color: #3b82f6; }
    .logo-motors { color: #1e293b; }
    .dark .logo-motors { color: #f8fafc; }

    .main-container { display: flex; min-height: calc(100vh - 80px); }

    #sidebar {
        width: 280px;
        background: white;
        border-right: 1px solid #e2e8f0;
        padding: 2rem 1rem;
    }
    .dark #sidebar { background: #1e293b; border-right: 1px solid #334155; }

    .brand {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem;
        margin-bottom: 2rem;
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        color: white;
        border-radius: 0.75rem;
        font-weight: 700;
        font-size: 1.25rem;
        text-decoration: none;
    }

    .side-menu { list-style: none; padding: 0; margin: 0; }
    .side-menu li { margin-bottom: 0.5rem; }
    .side-menu a {
        display: flex;
        align-items: center;
        padding: 1rem;
        color: #475569;
        text-decoration: none;
        border-radius: 0.75rem;
        transition: all 0.3s ease;
    }
    .dark .side-menu a { color: #cbd5e1; }
    .side-menu a:hover { background: #f1f5f9; color: #3b82f6; }
    .dark .side-menu a:hover { background: #334155; }

    main { flex: 1; padding: 2rem; background: #f8fafc; }
    .dark main { background: #0f172a; }

    main section {
        display: none;
        background: white;
        border-radius: 1rem;
        padding: 2rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
    }
    .dark main section { background: #1e293b; }

    main section#bienvenida {
        display: block;
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        color: white;
    }

    .metric-card {
        background: white;
        border-radius: 1rem;
        padding: 1.5rem;
        border-left: 4px solid #3b82f6;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }
    .dark .metric-card { background: #1e293b; }
    .metric-card:hover { transform: translateY(-5px); }

    .metric-value {
        font-size: 2rem;
        font-weight: 800;
        color: #3b82f6;
        margin-bottom: 0.5rem;
    }
    .dark .metric-value { color: #60a5fa; }

    table { width: 100%; border-collapse: collapse; margin: 1.5rem 0; border-radius: 0.75rem; overflow: hidden; }
    thead { background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; }
    th, td { padding: 1rem; text-align: left; border-bottom: 1px solid #e2e8f0; }
    .dark th, .dark td { border-bottom: 1px solid #334155; }

    .btn-asesor {
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        border: none;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    .btn-asesor:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .btn-contactar {
        background: #10b981;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        border: none;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s ease;
    }

    .btn-contactar:disabled {
        background: #9ca3af;
        cursor: not-allowed;
    }

    .btn-contactar:hover:not(:disabled) {
        background: #059669;
        transform: translateY(-1px);
    }

    .estado-prospecto {
        padding: 0.5rem 1rem;
        border-radius: 1rem;
        font-size: 0.875rem;
        font-weight: 600;
        display: inline-block;
    }

    .estado-pendiente { background: #fef3c7; color: #92400e; }
    .estado-contactado { background: #dbeafe; color: #1e40af; }
    .estado-testdrive { background: #dcfce7; color: #166534; }
    .estado-negociacion { background: #f3e8ff; color: #6b21a8; }
    .estado-aprobada { background: #dcfce7; color: #166534; }
    .estado-cancelada { background: #fecaca; color: #dc2626; }

    .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }

    .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 2rem;
        border-radius: 1rem;
        width: 90%;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
    }
    .dark .modal-content { background-color: #1e293b; }

    .close {
        color: #aaa;
        float: right;
        font-size: 1.5rem;
        font-weight: bold;
        cursor: pointer;
    }

    .close:hover { color: #000; }
    .dark .close:hover { color: #fff; }

    .form-group {
        margin-bottom: 1rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        background: white;
    }
    .dark .form-group input,
    .dark .form-group select,
    .dark .form-group textarea {
        background: #374151;
        border-color: #4b5563;
        color: white;
    }

    .prospecto-card {
        background: white;
        border-radius: 1rem;
        padding: 1.5rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        border-left: 4px solid #3b82f6;
    }
    .dark .prospecto-card { background: #1e293b; }

    .timeline {
        position: relative;
        padding-left: 2rem;
        margin: 1.5rem 0;
    }
    .timeline:before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 2px;
        background: #e2e8f0;
    }
    .dark .timeline:before { background: #334155; }
    .timeline-item {
        position: relative;
        margin-bottom: 1.5rem;
    }
    .timeline-item:before {
        content: '';
        position: absolute;
        left: -2rem;
        top: 0.5rem;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #3b82f6;
    }

    @media (max-width: 1024px) {
        .main-container { flex-direction: column; }
        #sidebar { display: none; }
    }
  </style>
</head>
<body class="dark:bg-background-dark">
<!-- Barra de navegación -->
<nav class="navbar">
  <div class="nav-logo">
    <span class="logo-nexgen">NextGen</span>
    <span class="logo-motors">Motors</span>
  </div>
  <div class="nav-links">
    <span class="text-sm text-gray-600 dark:text-gray-300 mr-4">Rol: <strong>Asesor</strong></span>
    <a th:href="@{/usuario/Inicio}" class="mr-4">Inicio Público</a>
    <a href="/logout">Cerrar Sesión</a>
  </div>
</nav>

<!-- Contenedor principal -->
<div class="main-container">
  <!-- Barra lateral -->
  <section id="sidebar">
    <a href="#" class="brand">
      <i class="fas fa-user-tie mr-2"></i>
      <span id="nombre-asesor">Cargando...</span>
    </a>
    <ul class="side-menu top">
      <li><a href="#bienvenida"><i class='fas fa-chart-line'></i><span>Dashboard</span></a></li>
      <li><a href="#prospectos"><i class='fas fa-users'></i><span>Mis Prospectos</span></a></li>
      <li><a href="#vehiculos"><i class='fas fa-car'></i><span>Vehículos</span></a></li>
      <li><a href="#agenda"><i class='fas fa-calendar-alt'></i><span>Agenda</span></a></li>
      <li><a href="#metas"><i class='fas fa-trophy'></i><span>Mis Metas</span></a></li>
      <li><a href="#" onclick="confirmarCerrarSesion()" class="logout"><i class='fas fa-sign-out-alt'></i><span>Cerrar Sesión</span></a></li>
    </ul>
  </section>

  <!-- Contenido principal -->
  <main>
    <!-- Bienvenida ASESOR -->
    <section id="bienvenida">
      <h1 class="text-3xl font-bold mb-4">Bienvenido, <span id="nombre-bienvenida">Cargando...</span></h1>
      <p class="text-lg opacity-90">Panel de gestión comercial. Gestiona tus prospectos, agenda citas y alcanza tus metas de ventas.</p>
      <div class="mt-6 grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="metric-card">
          <div class="metric-value" id="total-prospectos">0</div>
          <div class="text-sm text-gray-600 dark:text-gray-300">Prospectos Activos</div>
        </div>
        <div class="metric-card">
          <div class="metric-value" id="ventas-mes">0</div>
          <div class="text-sm text-gray-600 dark:text-gray-300">Ventas Este Mes</div>
        </div>
        <div class="metric-card">
          <div class="metric-value" id="tasa-conversion">0%</div>
          <div class="text-sm text-gray-600 dark:text-gray-300">Tasa de Conversión</div>
        </div>
        <div class="metric-card">
          <div class="metric-value" id="comisiones">$0</div>
          <div class="text-sm text-gray-600 dark:text-gray-300">Comisiones Pendientes</div>
        </div>
      </div>
    </section>

    <!-- ===================== PROSPECTOS SECTION ===================== -->
    <section id="prospectos">
      <div class="head-title mb-6">
        <h2 class="text-2xl font-bold">Gestión de Prospectos</h2>
        <p class="text-gray-600 dark:text-gray-300">Administra tus clientes potenciales y su proceso de venta</p>
      </div>

      <div class="table-container">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-semibold">Mis Prospectos</h3>
          <button onclick="mostrarModal('modal-prospecto')" class="btn-asesor">
            <i class="fas fa-plus mr-2"></i>Nuevo Prospecto
          </button>
        </div>
        <table id="tabla-prospectos" class="display">
          <thead>
          <tr>
            <th>Cliente</th>
            <th>Contacto</th>
            <th>Vehículo Interés</th>
            <th>Estado</th>
            <th>Último Contacto</th>
            <th>Próxima Acción</th>
            <th>Acciones</th>
          </tr>
          </thead>
          <tbody id="cuerpo-tabla-prospectos">
          <!-- Los datos se cargarán dinámicamente aquí -->
          <tr>
            <td colspan="7" class="text-center py-4">
              <div class="loading mx-auto"></div>
              <span class="ml-2">Cargando prospectos...</span>
            </td>
          </tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- ===================== VEHÍCULOS SECTION ===================== -->
    <section id="vehiculos">
      <div class="head-title mb-6">
        <h2 class="text-2xl font-bold">Catálogo de Vehículos</h2>
        <p class="text-gray-600 dark:text-gray-300">Explora los vehículos disponibles para ofrecer a tus clientes</p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <div class="prospecto-card">
          <div class="flex justify-between items-start mb-4">
            <h3 class="font-bold text-lg">Toyota RAV4</h3>
            <span class="text-sm font-semibold bg-blue-100 text-blue-800 px-2 py-1 rounded">SUV</span>
          </div>
          <img src="https://images.unsplash.com/photo-1621007947382-bb3c3994e3fb?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1000&q=80" alt="Toyota RAV4" class="w-full h-48 object-cover rounded-lg mb-4">
          <div class="mb-4">
            <p class="text-gray-600 dark:text-gray-300 mb-2"><strong>Precio:</strong> $32,500</p>
            <p class="text-gray-600 dark:text-gray-300 mb-2"><strong>Año:</strong> 2024</p>
            <p class="text-gray-600 dark:text-gray-300"><strong>Disponibilidad:</strong> En stock</p>
          </div>
          <button class="btn-asesor w-full">
            <i class="fas fa-share mr-2"></i>Compartir con Cliente
          </button>
        </div>

        <div class="prospecto-card">
          <div class="flex justify-between items-start mb-4">
            <h3 class="font-bold text-lg">Ford Mustang</h3>
            <span class="text-sm font-semibold bg-purple-100 text-purple-800 px-2 py-1 rounded">Deportivo</span>
          </div>
          <img src="https://images.unsplash.com/photo-1544636331-e26879cd4d9b?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1000&q=80" alt="Ford Mustang" class="w-full h-48 object-cover rounded-lg mb-4">
          <div class="mb-4">
            <p class="text-gray-600 dark:text-gray-300 mb-2"><strong>Precio:</strong> $45,200</p>
            <p class="text-gray-600 dark:text-gray-300 mb-2"><strong>Año:</strong> 2024</p>
            <p class="text-gray-600 dark:text-gray-300"><strong>Disponibilidad:</strong> En stock</p>
          </div>
          <button class="btn-asesor w-full">
            <i class="fas fa-share mr-2"></i>Compartir con Cliente
          </button>
        </div>

        <div class="prospecto-card">
          <div class="flex justify-between items-start mb-4">
            <h3 class="font-bold text-lg">Honda CR-V</h3>
            <span class="text-sm font-semibold bg-blue-100 text-blue-800 px-2 py-1 rounded">SUV</span>
          </div>
          <img src="https://images.unsplash.com/photo-1621007947382-bb3c3994e3fb?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1000&q=80" alt="Honda CR-V" class="w-full h-48 object-cover rounded-lg mb-4">
          <div class="mb-4">
            <p class="text-gray-600 dark:text-gray-300 mb-2"><strong>Precio:</strong> $29,800</p>
            <p class="text-gray-600 dark:text-gray-300 mb-2"><strong>Año:</strong> 2024</p>
            <p class="text-gray-600 dark:text-gray-300"><strong>Disponibilidad:</strong> En stock</p>
          </div>
          <button class="btn-asesor w-full">
            <i class="fas fa-share mr-2"></i>Compartir con Cliente
          </button>
        </div>
      </div>
    </section>

    <!-- ===================== AGENDA SECTION ===================== -->
    <section id="agenda">
      <div class="head-title mb-6">
        <h2 class="text-2xl font-bold">Gestión de Citas</h2>
        <p class="text-gray-600 dark:text-gray-300">Administra las citas asignadas a tus prospectos</p>
      </div>

      <div class="mb-6">
        <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
          <div>
            <h3 class="text-xl font-semibold">Mis Citas</h3>
          </div>
          <select id="filtro-estado" class="w-full lg:w-48 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
            <option value="TODAS">Todas las citas</option>
            <option value="Pendiente">Pendientes</option>
            <option value="Aprobada">Aprobadas</option>
            <option value="Rechazada">Rechazadas</option>
            <option value="Contactado">Contactados</option>
          </select>
        </div>
      </div>

      <div class="table-container">
        <div class="overflow-x-auto">
          <table id="tabla-citas" class="w-full min-w-full">
            <thead class="bg-gray-50 dark:bg-gray-700">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Cliente</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Tipo</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Auto</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Fecha Solicitud</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Comentario</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Estado</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Fecha Asignada</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Notas</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Acciones</th>
            </tr>
            </thead>
            <tbody id="cuerpo-tabla-citas" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
            <!-- Los datos se cargarán dinámicamente aquí -->
            <tr>
              <td colspan="9" class="text-center py-8">
                <div class="loading mx-auto"></div>
                <span class="ml-2">Cargando citas...</span>
              </td>
            </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Modal para Asignar Fecha -->
    <div id="modal-fecha" class="modal">
      <div class="modal-content">
        <span class="close text-2xl cursor-pointer float-right hover:text-gray-600 transition-colors" onclick="cerrarModal('modal-fecha')">&times;</span>
        <h2 class="text-2xl font-bold mb-6 text-gray-900 dark:text-white">Asignar Fecha</h2>
        <div class="space-y-6">
          <div class="form-group">
            <label for="fecha-asignacion">Fecha</label>
            <input type="date" id="fecha-asignacion" class="form-control">
          </div>
          <div class="form-group">
            <label for="hora-asignacion">Hora</label>
            <input type="time" id="hora-asignacion" class="form-control">
          </div>
          <div class="flex flex-col lg:flex-row gap-4 pt-4">
            <button onclick="confirmarFecha()" class="btn-asesor flex-1">Confirmar</button>
            <button type="button" class="btn-secondary" onclick="cerrarModal('modal-fecha')">Cancelar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal para Notas -->
    <div id="modal-notas" class="modal">
      <div class="modal-content">
        <span class="close text-2xl cursor-pointer float-right hover:text-gray-600 transition-colors" onclick="cerrarModal('modal-notas')">&times;</span>
        <h2 class="text-2xl font-bold mb-6 text-gray-900 dark:text-white">Notas de Seguimiento</h2>
        <div class="space-y-6">
          <div class="form-group">
            <label for="texto-notas">Notas</label>
            <textarea id="texto-notas" class="form-control" rows="5" placeholder="Agregar notas de seguimiento..."></textarea>
          </div>
          <div class="flex flex-col lg:flex-row gap-4 pt-4">
            <button onclick="guardarNotas()" class="btn-asesor flex-1">Guardar</button>
            <button type="button" class="btn-secondary" onclick="cerrarModal('modal-notas')">Cancelar</button>
          </div>
        </div>
      </div>
    </div>

  </main>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script>
  // Variables globales
  let tablaProspectos;
  let tablaCitas;
  let citaActualId = null;

  // Navegación entre secciones
  document.addEventListener('DOMContentLoaded', function() {
      document.querySelectorAll('main section').forEach(section => {
          section.style.display = 'none';
      });
      document.getElementById('bienvenida').style.display = 'block';

      document.querySelectorAll('.side-menu a').forEach(link => {
          link.addEventListener('click', function(e) {
              if (this.getAttribute('href').startsWith('#')) {
                  e.preventDefault();
                  document.querySelectorAll('main section').forEach(section => {
                      section.style.display = 'none';
                  });
                  const targetId = this.getAttribute('href').substring(1);
                  document.getElementById(targetId).style.display = 'block';

                  // Cargar datos específicos cuando se cambia de sección
                  if (targetId === 'prospectos') {
                      cargarProspectos();
                  } else if (targetId === 'agenda') {
                      cargarCitas();
                  }
              }
          });
      });

      // Cargar datos iniciales
      cargarDatosIniciales();
  });

  // Función para cargar datos iniciales del asesor
  async function cargarDatosIniciales() {
      try {
          // Cargar información del asesor
          const response = await fetch('/asesor/datos');
          if (!response.ok) throw new Error('Error en la respuesta del servidor');

          const datosAsesor = await response.json();

          document.getElementById('nombre-asesor').textContent = datosAsesor.nombre;
          document.getElementById('nombre-bienvenida').textContent = datosAsesor.nombre;
          document.getElementById('total-prospectos').textContent = datosAsesor.totalProspectos;
          document.getElementById('ventas-mes').textContent = datosAsesor.ventasMes;
          document.getElementById('tasa-conversion').textContent = datosAsesor.tasaConversion + '%';
          document.getElementById('comisiones').textContent = '$' + datosAsesor.comisiones.toLocaleString();

      } catch (error) {
          console.error('Error al cargar datos del asesor:', error);
          mostrarNotificacion('Error al cargar datos del perfil', 'error');
      }
  }

  // Función para cargar prospectos
  async function cargarProspectos() {
      try {
          const response = await fetch('/asesor/prospectos');
          if (!response.ok) throw new Error('Error en la respuesta del servidor');

          const prospectos = await response.json();

          const cuerpoTabla = document.getElementById('cuerpo-tabla-prospectos');
          cuerpoTabla.innerHTML = '';

          if (prospectos.length === 0) {
              cuerpoTabla.innerHTML = `
                  <tr>
                      <td colspan="7" class="text-center py-4 text-gray-500">
                          No hay prospectos asignados
                      </td>
                  </tr>
              `;
              return;
          }

          prospectos.forEach(prospecto => {
              const fila = document.createElement('tr');

              // Formatear fechas
              const ultimoContacto = prospecto.ultimoContacto ?
                  new Date(prospecto.ultimoContacto).toLocaleDateString('es-ES') : 'N/A';

              const proximaAccion = prospecto.proximaAccion ?
                  `Cita - ${new Date(prospecto.proximaAccion).toLocaleDateString('es-ES')}` : 'Sin acción programada';

              // Determinar clase CSS para el estado
              const claseEstado = obtenerClaseEstado(prospecto.estado);
              const textoEstado = obtenerTextoEstado(prospecto.estado);

              fila.innerHTML = `
                  <td>${prospecto.nombreCompleto}</td>
                  <td>${prospecto.email}<br>${prospecto.telefono || 'Sin teléfono'}</td>
                  <td>${prospecto.vehiculoInteres || 'No especificado'}</td>
                  <td><span class="estado-prospecto ${claseEstado}">${textoEstado}</span></td>
                  <td>${ultimoContacto}</td>
                  <td>${proximaAccion}</td>
                  <td>
                      <button onclick="contactarProspecto('${prospecto.citaId}')" class="btn-contactar" ${prospecto.estado === 'Contactado' ? 'disabled' : ''}>
                          <i class="fas fa-phone mr-1"></i>${prospecto.estado === 'Contactado' ? 'Contactado' : 'Contactar'}
                      </button>
                  </td>
              `;

              cuerpoTabla.appendChild(fila);
          });

          // Reinicializar DataTables si existe
          if ($.fn.DataTable.isDataTable('#tabla-prospectos')) {
              tablaProspectos.destroy();
          }

          tablaProspectos = $('#tabla-prospectos').DataTable({
              language: {
                  url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json'
              },
              pageLength: 10,
              responsive: true
          });

      } catch (error) {
          console.error('Error al cargar prospectos:', error);
          mostrarNotificacion('Error al cargar los prospectos', 'error');
      }
  }

  // ===================== GESTIÓN DE CITAS =====================

  // Función para cargar citas
  async function cargarCitas() {
      try {
          const response = await fetch('/asesor/citas');
          if (!response.ok) throw new Error('Error en la respuesta del servidor');

          const citas = await response.json();
          const cuerpoTabla = document.getElementById('cuerpo-tabla-citas');
          cuerpoTabla.innerHTML = '';

          if (citas.length === 0) {
              cuerpoTabla.innerHTML = `
                  <tr>
                      <td colspan="9" class="text-center py-8 text-gray-500">
                          <div class="flex flex-col items-center justify-center">
                              <i class="fas fa-calendar-times text-4xl mb-2 text-gray-300"></i>
                              <p class="text-lg font-medium">No hay citas asignadas</p>
                          </div>
                      </td>
                  </tr>
              `;
              return;
          }

          citas.forEach(cita => {
              const fila = document.createElement('tr');
              fila.setAttribute('data-id', cita.id);
              fila.className = 'hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors';

              // Formatear fechas
              const fechaSolicitud = cita.fechaSolicitud ?
                  new Date(cita.fechaSolicitud).toLocaleDateString('es-ES') : '-';

              const fechaAsignada = cita.fechaAsignada ?
                  new Date(cita.fechaAsignada).toLocaleDateString('es-ES') + ' ' +
                  new Date(cita.fechaAsignada).toLocaleTimeString('es-ES', {hour: '2-digit', minute:'2-digit'}) : '-';

              fila.innerHTML = `
                  <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${cita.cliente || 'Sin nombre'}</td>
                  <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${cita.tipo}</td>
                  <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${cita.vehiculo}</td>
                  <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${fechaSolicitud}</td>
                  <td class="px-4 py-4 text-sm text-gray-900 dark:text-white max-w-xs truncate">${cita.comentario}</td>
                  <td class="px-4 py-4 whitespace-nowrap">
                      <span class="estado-badge ${obtenerClaseEstadoCita(cita.estado)}">${cita.estado}</span>
                  </td>
                  <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${fechaAsignada}</td>
                  <td class="px-4 py-4 text-sm text-gray-900 dark:text-white max-w-xs truncate">${cita.notasAdmin}</td>
                  <td class="px-4 py-4 whitespace-nowrap text-sm font-medium">
                      <div class="flex flex-wrap gap-1" id="botones-cita-${cita.id}">
                          ${generarBotonesCita(cita.estado, cita.id)}
                      </div>
                  </td>
              `;

              cuerpoTabla.appendChild(fila);
          });

          // Inicializar DataTables
          if ($.fn.DataTable.isDataTable('#tabla-citas')) {
              tablaCitas.destroy();
          }

          tablaCitas = $('#tabla-citas').DataTable({
              language: {
                  url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json'
              },
              pageLength: 10,
              responsive: true
          });

          // Configurar filtro
          document.getElementById('filtro-estado').addEventListener('change', function() {
              const estado = this.value;
              filtrarCitasPorEstado(estado);
          });

          // Event listeners para botones de citas
          document.addEventListener('click', function(e) {
              if (e.target.classList.contains('btn-gestion-cita')) {
                  const citaId = e.target.getAttribute('data-id');
                  const accion = e.target.getAttribute('data-accion');
                  citaActualId = citaId;

                  manejarAccionCita(accion, e.target);
              }
          });

      } catch (error) {
          console.error('Error al cargar citas:', error);
          mostrarNotificacion('Error al cargar las citas', 'error');
      }
  }

  // Función para generar botones según el estado de la cita
  function generarBotonesCita(estado, citaId) {
      let botones = '';

      switch(estado) {
          case 'Pendiente':
              botones = `
                  <button class="btn-gestion-cita btn-aprobar" data-id="${citaId}" data-accion="aprobar">Aprobar</button>
                  <button class="btn-gestion-cita btn-rechazar" data-id="${citaId}" data-accion="rechazar">Rechazar</button>
                  <button class="btn-gestion-cita btn-notas" data-id="${citaId}" data-accion="notas">Notas</button>
              `;
              break;
          case 'Aprobada':
              botones = `
                  <button class="btn-gestion-cita btn-asignar-fecha" data-id="${citaId}" data-accion="asignar-fecha">Asignar Fecha</button>
                  <button class="btn-gestion-cita btn-pendiente" data-id="${citaId}" data-accion="pendiente">A Pendiente</button>
                  <button class="btn-gestion-cita btn-notas" data-id="${citaId}" data-accion="notas">Notas</button>
              `;
              break;
          case 'Rechazada':
          case 'Contactado':
              botones = `
                  <button class="btn-gestion-cita btn-pendiente" data-id="${citaId}" data-accion="pendiente">A Pendiente</button>
                  <button class="btn-gestion-cita btn-notas" data-id="${citaId}" data-accion="notas">Notas</button>
              `;
              break;
          default:
              botones = `<button class="btn-gestion-cita btn-notas" data-id="${citaId}" data-accion="notas">Notas</button>`;
      }

      return botones;
  }

  // Función para obtener clase CSS del estado de cita
  function obtenerClaseEstadoCita(estado) {
      const estados = {
          'Pendiente': 'estado-pendiente',
          'Aprobada': 'estado-aprobada',
          'Rechazada': 'estado-rechazada',
          'Contactado': 'estado-contactado'
      };
      return estados[estado] || 'estado-pendiente';
  }

  // Manejar acciones de citas
  function manejarAccionCita(accion, boton) {
      switch(accion) {
          case 'aprobar':
              cambiarEstadoCita('Aprobada');
              break;
          case 'rechazar':
              cambiarEstadoCita('Rechazada');
              break;
          case 'asignar-fecha':
              mostrarModal('modal-fecha');
              break;
          case 'pendiente':
              cambiarEstadoCita('Pendiente');
              break;
          case 'notas':
              cargarNotasActuales();
              mostrarModal('modal-notas');
              break;
      }
  }

  // Cambiar estado de cita
  async function cambiarEstadoCita(nuevoEstado) {
      try {
          const response = await fetch(`/asesor/citas/${citaActualId}/cambiar-estado`, {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/x-www-form-urlencoded',
              },
              body: `estado=${nuevoEstado}`
          });

          if (response.ok) {
              mostrarNotificacion(`Estado cambiado a ${nuevoEstado}`, 'success');
              await cargarCitas(); // Recargar la tabla
          } else {
              throw new Error('Error en la respuesta del servidor');
          }
      } catch (error) {
          console.error('Error al cambiar estado:', error);
          mostrarNotificacion('Error al cambiar el estado', 'error');
      }
  }

  // Cargar notas actuales de la cita
  function cargarNotasActuales() {
      const fila = document.querySelector(`tr[data-id="${citaActualId}"]`);
      if (fila) {
          const notasActuales = fila.querySelector('td:nth-child(8)').textContent;
          document.getElementById('texto-notas').value = notasActuales !== 'Sin notas' ? notasActuales : '';
      }
  }

  // Confirmar asignación de fecha
  async function confirmarFecha() {
      const fecha = document.getElementById('fecha-asignacion').value;
      const hora = document.getElementById('hora-asignacion').value;

      if (!fecha || !hora) {
          mostrarNotificacion('Por favor selecciona fecha y hora', 'error');
          return;
      }

      try {
          const response = await fetch(`/asesor/citas/${citaActualId}/asignar-fecha`, {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/x-www-form-urlencoded',
              },
              body: `fecha=${fecha}&hora=${hora}`
          });

          if (response.ok) {
              mostrarNotificacion('Fecha asignada correctamente', 'success');
              cerrarModal('modal-fecha');
              await cargarCitas(); // Recargar la tabla
          } else {
              throw new Error('Error en la respuesta del servidor');
          }
      } catch (error) {
          console.error('Error al asignar fecha:', error);
          mostrarNotificacion('Error al asignar fecha', 'error');
      }
  }

  // Guardar notas de la cita
  async function guardarNotas() {
      const notas = document.getElementById('texto-notas').value;

      try {
          const response = await fetch(`/asesor/citas/${citaActualId}/guardar-notas`, {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/x-www-form-urlencoded',
              },
              body: `notas=${encodeURIComponent(notas)}`
          });

          if (response.ok) {
              mostrarNotificacion('Notas guardadas correctamente', 'success');
              cerrarModal('modal-notas');
              await cargarCitas(); // Recargar la tabla
          } else {
              throw new Error('Error en la respuesta del servidor');
          }
      } catch (error) {
          console.error('Error al guardar notas:', error);
          mostrarNotificacion('Error al guardar notas', 'error');
      }
  }

  // Filtrar citas por estado
  function filtrarCitasPorEstado(estado) {
      if (!tablaCitas) return;

      if (estado === 'TODAS') {
          tablaCitas.search('').draw();
      } else {
          tablaCitas.column(5).search(estado).draw();
      }
  }

  // ===================== FUNCIONES EXISTENTES =====================

  // Función para mapear estados a clases CSS
  function obtenerClaseEstado(estado) {
      const estados = {
          'Pendiente': 'estado-pendiente',
          'Contactado': 'estado-contactado',
          'Test Drive': 'estado-testdrive',
          'Negociación': 'estado-negociacion',
          'Aprobada': 'estado-aprobada',
          'Cancelada': 'estado-cancelada'
      };
      return estados[estado] || 'estado-pendiente';
  }

  // Función para mapear estados a texto legible
  function obtenerTextoEstado(estado) {
      const textos = {
          'Pendiente': 'Pendiente',
          'Contactado': 'Contactado',
          'Test Drive': 'Test Drive',
          'Negociación': 'Negociación',
          'Aprobada': 'Aprobada',
          'Cancelada': 'Cancelada'
      };
      return textos[estado] || estado;
  }

  // Función para contactar prospecto
  async function contactarProspecto(citaId) {
      try {
          const response = await fetch('/asesor/prospectos/contactar', {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/x-www-form-urlencoded',
              },
              body: `citaId=${citaId}`
          });

          if (response.ok) {
              mostrarNotificacion('Prospecto marcado como contactado', 'success');
              // Recargar la tabla
              await cargarProspectos();
              await cargarDatosIniciales(); // Actualizar métricas
          } else {
              throw new Error('Error en la respuesta del servidor');
          }
      } catch (error) {
          console.error('Error al contactar prospecto:', error);
          mostrarNotificacion('Error al contactar el prospecto', 'error');
      }
  }

  // Función para mostrar notificaciones
  function mostrarNotificacion(mensaje, tipo) {
      // Crear elemento de notificación
      const notificacion = document.createElement('div');
      notificacion.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
          tipo === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
      }`;
      notificacion.textContent = mensaje;

      document.body.appendChild(notificacion);

      // Remover después de 3 segundos
      setTimeout(() => {
          if (document.body.contains(notificacion)) {
              document.body.removeChild(notificacion);
          }
      }, 3000);
  }

  // Funciones para manejar los modales
  function mostrarModal(modalId) {
      document.getElementById(modalId).style.display = 'block';
  }

  function cerrarModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
  }

  // Cerrar modales al hacer clic fuera
  window.onclick = function(event) {
      if (event.target.className === 'modal') {
          event.target.style.display = 'none';
      }
  }

  function confirmarCerrarSesion() {
      if (confirm('¿Está seguro de que desea cerrar sesión?')) {
          window.location.href = '/logout';
      }
  }
</script>
</body>
</html>